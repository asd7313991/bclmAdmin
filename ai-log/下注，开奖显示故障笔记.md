# 开奖参数对应故障笔记（服务器侧）

> 适用范围：加拿大 28 / 28 系玩法；服务模块：`f6mj-game`（结算）、`f6mj-system`（管理）、`f6mj-player`（账变）；DB 相关表：`HfGameIssueDO`、`HfGameOrderDO`、`DreamUFinanceMainDO`、`DreamUFinanceFlowDO`。

---

## 1. 摘要（Summary）

* **现象**：同一期开奖后，部分订单结算结果与预期不一致（命中/未命中），或前端展示的“快捷投注标签（小/大/单双/极大/极小/大小单/大小双）”与服务器结算不一致。
* **影响**：

    * 结算正确性：错误派彩、误判中奖/未中；
    * 列表与筛选：前端筛选“已中奖/未中奖/未开奖”与真实状态不一致；
    * 财务：`DreamUFinanceFlowDO` 出入账对不上。
* **根因（定位结果）**：服务器端**玩法枚举/赔率项**与前端快捷映射的**数值编码**不一致，或结算侧对“大小/单双/极值/大小单双”的**区间定义**与前端不一致；部分场景还涉及**开奖和值计算**与**区间边界**的差异（例如：`0-13` 为“小”，`14-27` 为“大”）。

---

## 2. 复现路径（Reproduction）

1. 指定一期 `issueCode`，在前端下发如下快捷投注：小/大、单/双、极大/极小、大小单双（示例：小单）。
2. 开奖产生结果数 `n ∈ [0,27]`。
3. 前端按自身映射显示命中；服务器结算按另一套映射判断，产生分歧（典型为**极值**与**大小单双**）。

---

## 3. 关键参数/定义（统一口径）

> 服务器与前端必须严格一致；以下为**建议的标准定义**。

### 3.1 开和值 `sum28`

* 取三段或多段源值求和后再 `% 28`（视数据源），最终落在 `0..27`。

### 3.2 区间与标签

| 标签 | 代码值(value) | 集合/区间定义                  |
| -- | ---------: | ------------------------ |
| 小  |         30 | `0..13`                  |
| 大  |         31 | `14..27`                 |
| 单  |         28 | `奇数`                     |
| 双  |         29 | `偶数`                     |
| 极小 |         32 | `0..5`                   |
| 极大 |         33 | `22..27`                 |
| 小单 |         36 | `{1,3,5,7,9,11,13}`      |
| 大单 |         34 | `{15,17,19,21,23,25,27}` |
| 小双 |         37 | `{0,2,4,6,8,10,12}`      |
| 大双 |         35 | `{14,16,18,20,22,24,26}` |

> 注：以上 **value** 与前端快捷面板一致；服务端枚举（如 `GameBetTypeEnum`/`PlayType`）需保持一一对应。

---

## 4. 受影响模块/代码入口

* **定时开奖/结算**：`f6mj-game` → `GameIssueTask` → `HfGameIssueServiceImpl#drawGameIssue(...)`
* **订单入库**：`HfGameOrderDO`（含字段：`issuecode`、`ordercode`、`numberrecord`/`betType`/`betContent` 等）
* **派彩**：`DreamUFinanceMainService`、`DreamUFinanceFlowService`，账变类型见 `FinanceFlowType`。
* **枚举/常量**：`org.example.game.game.enums.*`（玩法枚举、结算逻辑用到的映射表）、`GameBetRedisKey`（缓存键）

> 实际包名/类名以仓库为准；本笔记基于现有命名推断。

---

## 5. 日志与数据证据（Checklist）

* 任务日志：

    * `getIssueNum` 拉取/计算和值日志（确认 `sum28`）。
    * `drawGameIssue` 订单遍历与命中判断日志。
* DB 快速校验（示例 SQL，请按表名/字段名校对）：

  ```sql
  -- 1) 查询某期订单与开奖结果
  SELECT o.id, o.issuecode, o.ordercode, o.userid, o.bet_type, o.numberrecord, o.totalamount, o.orderstatus
  FROM hf_game_order o
  WHERE o.issuecode = '3326379';

  SELECT i.issuecode, i.open_num, i.sum28
  FROM hf_game_issue i
  WHERE i.issuecode = '3326379';

  -- 2) 统计该期“极大/极小”等类型的中奖/未中奖分布
  SELECT bet_type, orderstatus, COUNT(*)
  FROM hf_game_order
  WHERE issuecode = '3326379'
  GROUP BY bet_type, orderstatus;

  -- 3) 财务流水核对（派彩是否与中奖订单数匹配）
  SELECT type, SUM(amount)
  FROM dream_u_finance_flow
  WHERE issuecode = '3326379'
  GROUP BY type;
  ```

---

## 6. 根因定位（Root Cause）

* **枚举/字典不一致**：服务端 `bet_type` ↔ 前端 `value` 未对齐（如“极大/极小/大小单双”的 code 错位）。
* **区间边界不一致**：服务端把 `0..4` 作为极小，而前端使用 `0..5`；或把 `23..27` 视为极大，而前端 `22..27`。
* **重写/重构遗留**：新版枚举或赔率配置变更后，结算侧未同步更新命中判断表。
* **缓存旧字典**：`Redis` 中玩法映射缓存未刷新，导致结算与下单映射使用不同版本。

---

## 7. 修复方案（Fix Plan）

1. **统一映射源**：在 `game` 模块增加单一数据源：

    * `BetDict.java`（或配置表）维护 *value ↔ 标签 ↔ 区间/集合*；
    * 结算与下单均依赖该源，避免双写。
2. **对齐枚举值**：确保服务端枚举值与前端一致（见“3.2 区间与标签”表）；若当前 DB 已存错位值，需做数据脚本修复（见下）。
3. **单元测试**：新增覆盖 0..27 的全量用例，断言每个 `sum28` 的命中集合；

    * 关键断言：`0,1,2,3,4,5` 命中“极小”；`22,23,24,25,26,27` 命中“极大”；大小单双集合与表一致。
4. **灰度验证**：在测试服跑最近 100 期的历史结算对比（服务端 vs 前端脚本）并人工抽样。
5. **缓存刷新**：发布后清理 `GameBetRedisKey` 相关缓存键。

---

## 8. 历史数据修复（Data Patch）

> 场景：历史订单因映射错位被误判。

1. **范围确定**：按上线时间点，选取疑似受影响区间（例如近 3 天或按 `issuecode` 段）。
2. **回滚/重结算脚本**（伪代码思路）：

    * 拉取该范围内订单与对应 `sum28`；
    * 用**新映射**重算命中；
    * 对“命中状态有差异”的订单：

        * 生成*反向财务流水*冲正旧账；
        * 生成*新派彩流水*；
        * 更新 `orderstatus`。
3. **幂等保障**：为修复批次加标记（如 `repair_batch_id`），重复执行不产生二次账变。

---

## 9. 发布与回滚

* **发布**：`f6mj-game` 优先发布（结算逻辑），随后 `system`/`player` 同步（如枚举常量也在这些模块使用）。
* **回滚**：如出现异常，回滚至前版本，并清理新缓存；数据修复批次若已执行，需执行对应的**反向修复**（仅在必要时）。

---

## 10. 验证用例（抽样）

* `sum28=0`：命中【小、双、极小、小双】。
* `sum28=13`：命中【小、单、小单】；**边界**。
* `sum28=14`：命中【大、双、大双】；**边界**。
* `sum28=22`：命中【大、双、大双、极大】；**边界**。
* `sum28=27`：命中【大、单、大单、极大】；**边界**。

---

## 11. Owner / 责任人

* **排查/修复**：后端（game）@负责人A；前端 @负责人B；DB/账务 @负责人C。
* **审批**：技术经理 @M；产品/风控 @P。

---

## 12. 附：对齐清单（上线前必须全绿）

* [ ] 服务端枚举 value 与前端快捷 value 全量对齐（28\~37）。
* [ ] 结算命中表中的集合与前端一致（见 3.2 表）。
* [ ] 最近 100 期重算比对无差异。
* [ ] 缓存刷新验证通过。
* [ ] 财务流水与订单条数核对通过。
* [ ] 回滚预案与数据修复脚本已准备。
